<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Relay Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Relay Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-50","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44373548-50"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-44373548-50",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Relay" href="/opensearch.xml"><title data-react-helmet="true">Runtime Architecture | Relay</title><meta data-react-helmet="true" property="og:image" content="https://relay.dev/img/relay.png"><meta data-react-helmet="true" name="twitter:image" content="https://relay.dev/img/relay.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Relay"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="v10.1.3"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-v10.1.3"><meta data-react-helmet="true" property="og:title" content="Runtime Architecture | Relay"><meta data-react-helmet="true" name="description" content="The Relay runtime is a full-featured GraphQL client that is designed for high performance even on low-end mobile devices and is capable of scaling to large, complex apps. The runtime API is not intended to be used directly in product code, but rather to provide a foundation for building higher-level product APIs such as React/Relay. This foundation includes:"><meta data-react-helmet="true" property="og:description" content="The Relay runtime is a full-featured GraphQL client that is designed for high performance even on low-end mobile devices and is capable of scaling to large, complex apps. The runtime API is not intended to be used directly in product code, but rather to provide a foundation for building higher-level product APIs such as React/Relay. This foundation includes:"><meta data-react-helmet="true" property="og:url" content="https://relay.dev/docs/v10.1.3/runtime-architecture"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://relay.dev/docs/v10.1.3/runtime-architecture"><link rel="stylesheet" href="/styles.c3a6de2f.css">
<link rel="preload" href="/styles.b3d6ad44.js" as="script">
<link rel="preload" href="/runtime~main.97b369c3.js" as="script">
<link rel="preload" href="/main.1ad2bb6a.js" as="script">
<link rel="preload" href="/1.5180c3fa.js" as="script">
<link rel="preload" href="/2.77ef3bb8.js" as="script">
<link rel="preload" href="/3.e784de96.js" as="script">
<link rel="preload" href="/1be78505.92f65075.js" as="script">
<link rel="preload" href="/247.ab089541.js" as="script">
<link rel="preload" href="/52d75dfb.774bdfee.js" as="script">
<link rel="preload" href="/17896441.02b9ab90.js" as="script">
<link rel="preload" href="/ecaeb3a5.b1ffd921.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">Relay</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/help">Help</a><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/v10.1.3/">v10.1.3</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next 🚧</a></li><li><a class="dropdown__link" href="/docs/">v11.0.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v10.1.3/runtime-architecture">v10.1.3</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><div class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></div></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">Relay</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/help">Help</a></li><li class="menu__list-item"><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/">Next 🚧</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/">v11.0.0</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/v10.1.3/runtime-architecture">v10.1.3</a></li><li class="menu__list-item"><a class="menu__link" href="/versions">All versions</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/">Introduction to Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/prerequisites">Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/installation-and-setup">Installation and Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/quick-start-guide">Quick Start Guide</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">API Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/graphql-in-relay">GraphQL in Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/relay-environment">Relay Environment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/network-layer">Network Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/query-renderer">QueryRenderer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/fragment-container">Fragment Container</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/refetch-container">Refetch Container</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/pagination-container">Pagination Container</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/mutations">Mutations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/subscriptions">Subscriptions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/relay-store">Relay Store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/fetch-query">fetchQuery</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/routing">Routing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/relay-debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/graphql-server-specification">GraphQL Server Specification</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/persisted-queries">Persisted Queries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/type-emission">Type Emission</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/testing-relay-components">Testing Relay Components</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/local-state-management">Local State Management</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Principles &amp; Architecture</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v10.1.3/thinking-in-graphql">Thinking in GraphQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v10.1.3/thinking-in-relay">Thinking In Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v10.1.3/architecture-overview">Architecture Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v10.1.3/compiler-architecture">Compiler Architecture</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/v10.1.3/runtime-architecture">Runtime Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v10.1.3/videos">Videos</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Community</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v10.1.3/community-learning-resources">Community Learning Resources</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Relay <strong>v10.1.3</strong>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/docs/">latest version</a></strong> (v11.0.0).</div></div><div class="docItemContainer_a7m4"><article><div><span class="badge badge--secondary">Version: v10.1.3</span></div><header><h1 class="docTitle_Oumm">Runtime Architecture</h1></header><div class="markdown"><p>The Relay runtime is a full-featured GraphQL client that is designed for high performance even on low-end mobile devices and is capable of scaling to large, complex apps. The runtime API is not intended to be used directly in product code, but rather to provide a foundation for building higher-level product APIs such as React/Relay. This foundation includes:</p><ul><li>A normalized, in-memory object graph/cache.</li><li>An optimized &quot;write&quot; operation for updating the cache with the results of queries/mutations/subscriptions.</li><li>A mechanism for reading data from the cache and subscribing for updates when these results change due to a mutation, subscription update, etc.</li><li>Garbage collection to evict entries from the cache when they can no longer be referenced by any view.</li><li>A generic mechanism for intercepting data prior to publishing it to the cache and either synthesizing new data or merging new and existing data together (which among other things enables the creation of a variety of pagination schemes).</li><li>Mutations with optimistic updates and the ability to update the cache with arbitrary logic.</li><li>Support for live queries where supported by the network/server.</li><li>Core primitives to enable subscriptions.</li><li>Core primitives for building offline/persisted caching.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="comparison-to-classic-relay"></a>Comparison to Classic Relay<a class="hash-link" href="#comparison-to-classic-relay" title="Direct link to heading">#</a></h2><p>For users of classic Relay, note that the runtime makes as few assumptions as possible about GraphQL. Compared to earlier versions of Relay there is no concept of routes, there are no limitations on mutation input arguments or side-effects, arbitrary root fields just work, etc. At present, the main restriction from classic Relay that remains is the use of the <code>Node</code> interface and <code>id</code> field for object identification. However there is no fundamental reason that this restriction can&#x27;t be relaxed (there is a single place in the codebase where object identity is determined), and we welcome feedback from the community about ways to support customizable object identity without negatively impacting performance.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="data-types"></a>Data Types<a class="hash-link" href="#data-types" title="Direct link to heading">#</a></h2><p> (subsequent sections explain how these types are used in practice):</p><ul><li><code>DataID</code> (type): A globally unique or client-generated identifier for a record, stored as a string.</li><li><code>Record</code> (type): A representation of a distinct data entity with an identity, type, and fields. Note that the actual runtime representation is opaque to the system: all accesses to <code>Record</code> objects (including record creation) is mediated through the <code>RelayModernRecord</code> module. This allows the representation itself to be changed in a single place (e.g. to use <code>Map</code>s or a custom class). It is important that other code does not assume that <code>Record</code>s will always be plain objects.</li><li><code>RecordSource</code> (type): A collection of records keyed by their data ID, used both to represent the cache and updates to it. For example the store&#x27;s record cache is a <code>RecordSource</code> and the results of queries/mutations/subscriptions are normalized into <code>RecordSource</code>s that are published to a store. Sources also define methods for asynchronously loading records in order to (eventually) support offline use-cases. Currently the only implementation of this interface is <code>RelayInMemoryRecordSource</code>; future implementations may add support for loading records from disk.</li><li><code>Store</code> (type): The source of truth for an instance of <code>RelayRuntime</code>, holding the canonical set of records in the form of a <code>RecordSource</code> (though this is not required). Currently the only implementation is <code>RelayModernStore</code>.</li><li><code>Network</code> (type): Provides methods for fetching query data from and executing mutations against an external data source.</li><li><code>Environment</code> (type): Represents an encapsulated environment combining a <code>Store</code> and <code>Network</code>, providing a high-level API for interacting with both. This is the main public API of <code>RelayRuntime</code>.</li></ul><p>Types for working with queries and their results include:</p><ul><li><code>Selector</code> (type): A selector defines the starting point for a traversal into the graph for the purposes of targeting a subgraph, combining a GraphQL fragment, variables, and the Data ID for the root object from which traversal should progress. Intuitively, this &quot;selects&quot; a portion of the object graph.</li><li><code>Snapshot</code> (type): The (immutable) results of executing a <code>Selector</code> at a given point in time. This includes the selector itself, the results of executing it, and a list of the Data IDs from which data was retrieved (useful in determining when these results might change).</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="data-model"></a>Data Model<a class="hash-link" href="#data-model" title="Direct link to heading">#</a></h2><p>Relay Runtime is designed for use with GraphQL schemas that describe <strong>object graphs</strong> in which objects have a type, an identity, and a set of fields with values. Objects may reference each other, which is represented by fields whose values are one or more other objects in the graph [1]. To distinguish from JavaScript <code>Object</code>s, these units of data are referred to as <code>Record</code>s. Relay represents both its internal cache as well as query/mutation/etc results as a mapping of <strong>data ID</strong>s to <strong>records</strong>. The data ID is the unique (with respect to the cache) identifier for a record - it may be the value of an actual <code>id</code> field or based on the path to the record from the nearest object with an <code>id</code> (such path-based ids are called <strong>client ids</strong>). Each <code>Record</code> stores its data ID, type, and any fields that have been fetched. Multiple records are stored together as a <code>RecordSource</code>: a mapping of data IDs to <code>Record</code> instances.</p><p>For example, a user and their address might be represented as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// GraphQL Fragment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fragment on User {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  address {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    city</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id: &#x27;842472&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: &#x27;Joe&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  address: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    city: &#x27;Seattle&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Normalized Representation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RecordSource {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;842472&#x27;: Record {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __id: &#x27;842472&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __typename: &#x27;User&#x27;, // the type is known statically from the fragment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id: &#x27;842472&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &#x27;Joe&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address: {__ref: &#x27;client:842472:address&#x27;}, // link to another record</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;client:842472:address&#x27;: Record {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // A client ID, derived from the path from parent &amp; parent&#x27;s ID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __id: &#x27;client:842472:address&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __typename: &#x27;Address&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    city: &#x27;Seattle&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>[1] Note that GraphQL itself does not impose this constraint, and Relay Runtime may also be used for schemas that do not conform to it. For example, both systems can be used to query a single denormalized table. However, many of the features that Relay Runtime provides, such as caching and normalization, work best when the data is represented as a normalized graph with stable identities for discrete pieces of information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="store-operations"></a>Store Operations<a class="hash-link" href="#store-operations" title="Direct link to heading">#</a></h3><p>The <code>Store</code> is the source of truth for application data and provides the following core operations.</p><ul><li><p><code>lookup(selector: Selector): Snapshot</code>: Reads the results of a selector from the store, returning the value given the data currently in the store.</p></li><li><p><code>subscribe(snapshot: Snapshot, callback: (snapshot: Snapshot) =&gt; void): Disposable</code>: Subscribe to changes to the results of a selector. The callback is called when data has been published to the store that would cause the results of the snapshot&#x27;s selector to change.</p></li><li><p><code>publish(source: RecordSource): void</code>: Update the store with new information. All updates to the store are expressed in this form, including the results of queries/mutation/subscriptions as well as optimistic mutation updates. All of those operations internally create a new <code>RecordSource</code> instance and ultimately publish it to the store. Note that <code>publish()</code> does <em>not</em> immediately update any <code>subscribe()</code>-ers. Internally, the store compares the new <code>RecordSource</code> with its internal source, updating it as necessary:</p><ul><li>Records that exist only in the published source are added to the store.</li><li>Records that exist in both are merged into a new record (inputs unchanged), with the result added to the store.</li><li>Records that are null in the published source are deleted (set to null) in the store.</li><li>Records with a special sentinel value are removed from the store. This supports un-publishing optimistically created records.</li></ul></li><li><p><code>notify(): void</code>: Calls any <code>subscribe()</code>-ers whose results have changed due to intervening <code>publish()</code>-es. Separating <code>publish()</code> and <code>notify()</code> allows for multiple payloads to be published before performing any downstream update logic (such as rendering).</p></li><li><p><code>retain(selector: Selector): Disposable</code>: Ensure that all the records necessary to fulfill the given selector are retained in-memory. The records will not be eligible for garbage collection until the returned reference is disposed.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="example-data-flow-fetching-query-data"></a>Example Data Flow: Fetching Query Data<a class="hash-link" href="#example-data-flow-fetching-query-data" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               ┌───────────────────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               │         Query         │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               └───────────────────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                             ┌ ─ ─ ─ ┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         fetch ◀────────────▶ Server</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                             └ ─ ─ ─ ┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     ┌─────┴───────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     ▼             ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               ┌──────────┐  ┌──────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               │  Query   │  │ Response │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               └──────────┘  └──────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     │             │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     └─────┬───────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       normalize</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               ┌───────────────────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               │     RecordSource      │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               │                       │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               │┌──────┐┌──────┐┌─────┐│</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               ││Record││Record││ ... ││</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               │└──────┘└──────┘└─────┘│</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               └───────────────────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ol><li>The query is fetched from the network.</li><li>The query and response are traversed together, extracting the results into <code>Record</code> objects which are added to a fresh <code>RecordSource</code>.</li></ol><p>This fresh <code>RecordSource</code> would then be published to the store:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        publish</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             ┌───────────────────────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │           Store           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ ┌───────────────────────┐ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │     RecordSource      │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │                       │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │┌ ─ ─ ─ ┌ ─ ─ ─ ┌ ─ ─ ┐│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │ Record│ Record│  ...  │ │  &lt;--- records are updated</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │└ ─ ─ ─ └ ─ ─ ─ └ ─ ─ ┘│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ └───────────────────────┘ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ ┌───────────────────────┐ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │     Subscriptions     │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │                       │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │┌──────┐┌──────┐┌─────┐│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ ││ Sub. ││ Sub. ││ ... ││ │ &lt;--- subscriptions do not fire yet</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │└──────┘└──────┘└─────┘│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ └───────────────────────┘ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             └───────────────────────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Publishing the results updates the store but does <em>not</em> immediately notify any subscribers. This is accomplished by calling <code>notify()</code>...</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        notify</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             ┌───────────────────────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │           Store           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ ┌───────────────────────┐ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │     RecordSource      │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │                       │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │┌──────┐┌──────┐┌─────┐│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ ││Record││Record││ ... ││ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │└──────┘└──────┘└─────┘│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ └───────────────────────┘ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ ┌───────────────────────┐ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │     Subscriptions     │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │                       │ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │┌ ─ ─ ─ ┌ ─ ─ ─ ┌ ─ ─ ┐│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │  Sub. │  Sub. │  ...  │ │ &lt;--- affected subscriptions fire</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ │└ ─│─ ─ └ ─│─ ─ └ ─│─ ┘│ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             │ └───┼───────┼───────┼───┘ │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             └─────┼───────┼───────┼─────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   │       │       │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   ▼       │       │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               callback    │       │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           ▼       │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       callback    │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               callback</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>...which calls the callbacks for any <code>subscribe()</code>-ers whose results have changed. Each subscription is checked as follows:</p><ol><li>First, the list of data IDs that have changed since the last <code>notify()</code> is compared against data IDs listed in the subscription&#x27;s latest <code>Snapshot</code>. If there is no overlap, the subscription&#x27;s results cannot possibly have changed (if you imagine the graph visually, there is no overlap between the part of the graph that changed and the part that is selected). In this case the subscription is ignored, otherwise processing continues.</li><li>Second, any subscriptions that do have overlapping data IDs are re-read, and the new/previous results are compared. If the result has not changed, the subscription is ignored (this can occur if a field of a record changed that is not relevant to the subscription&#x27;s selector), otherwise processing continues.</li><li>Finally, subscriptions whose data actually changed are notified via their callback.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="example-data-flow-reading-and-observing-the-store"></a>Example Data Flow: Reading and Observing the Store<a class="hash-link" href="#example-data-flow-reading-and-observing-the-store" title="Direct link to heading">#</a></h3><p>Products access the store primarily via <code>lookup()</code> and <code>subscribe()</code>. Lookup reads the initial results of a fragment, and subscribe observes that result for any changes. Note that the output of <code>lookup()</code> - a <code>Snapshot</code> - is the input to <code>subscribe()</code>. This is important because the snapshot contains important information that can be used to optimize the subscription - if <code>subscribe()</code> accepted only a <code>Selector</code>, it would have to re-read the results in order to know what to subscribe to, which is less efficient.</p><p>Therefore a typical data flow is as follows - note that this flow is managed automatically by higher-level APIs such as React/Relay. First a component will lookup the results of a selector against a record source (e.g. the store&#x27;s canonical source):</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ┌───────────────────────┐       ┌──────────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    │     RecordSource      │       │              │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    │                       │       │              │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    │┌──────┐┌──────┐┌─────┐│       │   Selector   │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ││Record││Record││ ... ││       │              │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    │└──────┘└──────┘└─────┘│       │              │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    └───────────────────────┘       └──────────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                │                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                │                           │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                └──────────────┬────────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │  lookup</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │  (read)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        ┌─────────────┐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        │             │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        │  Snapshot   │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        │             │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        └─────────────┘</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │  render, etc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               │</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               ▼</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Next, it will <code>subscribe()</code> using this snapshot in order to be notified of any changes - see the above diagram for <code>publish()</code> and <code>notify()</code>.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/relay/edit/master/website/versioned_docs/version-v10.1.3/PrinciplesAndArchitecture-Runtime.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-04-07T21:59:07.000Z" class="docLastUpdatedAt_1Qna">4/7/2021</time> by <strong>Tim Yung</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/v10.1.3/compiler-architecture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Compiler Architecture</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/v10.1.3/videos"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Videos »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#comparison-to-classic-relay" class="table-of-contents__link">Comparison to Classic Relay</a></li><li><a href="#data-types" class="table-of-contents__link">Data Types</a></li><li><a href="#data-model" class="table-of-contents__link">Data Model</a><ul><li><a href="#store-operations" class="table-of-contents__link">Store Operations</a></li><li><a href="#example-data-flow-fetching-query-data" class="table-of-contents__link">Example Data Flow: Fetching Query Data</a></li><li><a href="#example-data-flow-reading-and-observing-the-store" class="table-of-contents__link">Example Data Flow: Reading and Observing the Store</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" rel="noopener noreferrer" href="/docs">Introduction</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" rel="noopener noreferrer" href="/users">User Showcase</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img class="footer__logo" src="/img/relay.svg"></div></div></div></footer></div>
<script src="/styles.b3d6ad44.js"></script>
<script src="/runtime~main.97b369c3.js"></script>
<script src="/main.1ad2bb6a.js"></script>
<script src="/1.5180c3fa.js"></script>
<script src="/2.77ef3bb8.js"></script>
<script src="/3.e784de96.js"></script>
<script src="/1be78505.92f65075.js"></script>
<script src="/247.ab089541.js"></script>
<script src="/52d75dfb.774bdfee.js"></script>
<script src="/17896441.02b9ab90.js"></script>
<script src="/ecaeb3a5.b1ffd921.js"></script>
</body>
</html>