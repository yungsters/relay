<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Relay Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Relay Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-50","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44373548-50"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-44373548-50",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Relay" href="/opensearch.xml"><title data-react-helmet="true">Persisted Queries | Relay</title><meta data-react-helmet="true" property="og:image" content="https://relay.dev/img/relay.png"><meta data-react-helmet="true" name="twitter:image" content="https://relay.dev/img/relay.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Relay"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="v11.0.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-v11.0.0"><meta data-react-helmet="true" property="og:title" content="Persisted Queries | Relay"><meta data-react-helmet="true" name="description" content="Persistence is handled by the relay command for you. You likely do not need to worry about the contents of this guide."><meta data-react-helmet="true" property="og:description" content="Persistence is handled by the relay command for you. You likely do not need to worry about the contents of this guide."><meta data-react-helmet="true" property="og:url" content="https://relay.dev/docs/guides/persisted-queries/"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://relay.dev/docs/guides/persisted-queries/"><link rel="stylesheet" href="/styles.c3a6de2f.css">
<link rel="preload" href="/styles.b3d6ad44.js" as="script">
<link rel="preload" href="/runtime~main.97b369c3.js" as="script">
<link rel="preload" href="/main.1ad2bb6a.js" as="script">
<link rel="preload" href="/1.5180c3fa.js" as="script">
<link rel="preload" href="/2.77ef3bb8.js" as="script">
<link rel="preload" href="/3.e784de96.js" as="script">
<link rel="preload" href="/1be78505.92f65075.js" as="script">
<link rel="preload" href="/247.ab089541.js" as="script">
<link rel="preload" href="/b81f3fb0.b00a0714.js" as="script">
<link rel="preload" href="/17896441.02b9ab90.js" as="script">
<link rel="preload" href="/6783d5f5.b2df26ef.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">Relay</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/help">Help</a><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/">v11.0.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/guides/persisted-queries/">Next ðŸš§</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/guides/persisted-queries/">v11.0.0</a></li><li><a class="dropdown__link" href="/docs/v10.1.3/">v10.1.3</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><div class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></div></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">Relay</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/help">Help</a></li><li class="menu__list-item"><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/guides/persisted-queries/">Next ðŸš§</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/guides/persisted-queries/">v11.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.1.3/">v10.1.3</a></li><li class="menu__list-item"><a class="menu__link" href="/versions">All versions</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Introduction to Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/prerequisites/">Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/installation-and-setup/">Installation and Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/step-by-step-guide/">Step-by-step Guide</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">A Guided Tour</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/workflow/">Workflow</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Rendering Data Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/rendering/queries/">Queries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/rendering/fragments/">Fragments</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/rendering/variables/">Variables</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/rendering/loading-states/">Loading States with Suspense</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/rendering/error-states/">Error States with ErrorBoundaries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/rendering/environment/">Environment</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Reusing Cached Data for Rendering</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/">Reusing Cached Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/fetch-policies/">Fetch Policies</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/availability-of-data/">Availability of Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/presence-of-data/">Presence of Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/staleness-of-data/">Staleness of Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/rendering-partially-cached-data/">Rendering Partially Cached Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/reusing-cached-data/filling-in-missing-data/">Filling in Missing Data (Missing Field Handlers)</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Refreshing and Refetching</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/refetching/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/refetching/refreshing-queries/">Refreshing Queries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/refetching/refetching-queries-with-different-data/">Refetching Queries with Different Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/refetching/refreshing-fragments/">Refreshing Fragments</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/refetching/refetching-fragments-with-different-data/">Refetching Fragments With Different Data</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Rendering List Data and Pagination</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/connections/">Connections</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/rendering-connections/">Rendering Connections</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/pagination/">Pagination</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/streaming-pagination/">Streaming Pagination</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/refetching-connections/">Refetching Connections (Using and Changing Filters)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/updating-connections/">Updating Connections</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/list-data/advanced-pagination/">Advanced Pagination</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Updating Data</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/updating-data/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/updating-data/graphql-mutations/">GraphQL Mutations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/updating-data/graphql-subscriptions/">GraphQL Subscriptions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/updating-data/local-data-updates/">Local Data Updates</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/updating-data/client-only-data/">Client-Only Data</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Managing Data Outside React</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guided-tour/accessing-data-without-react/retaining-queries/">Retaining Queries</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">API Reference</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Relay Hooks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/relay-environment-provider/">RelayEnvironmentProvider</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-relay-environment/">useRelayEnvironment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-preloaded-query/">usePreloadedQuery</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-query-loader/">useQueryLoader</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/load-query/">loadQuery</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-lazy-load-query/">useLazyLoadQuery</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-fragment/">useFragment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-refetchable-fragment/">useRefetchableFragment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-pagination-fragment/">usePaginationFragment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-mutation/">useMutation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-subscription/">useSubscription</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Entrypoint APIs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/use-entrypoint-loader/">useEntryPointLoader</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/load-entrypoint/">loadEntryPoint</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/entrypoint-container/">EntryPointContainer</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Relay Runtime</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/fetch-query/">fetchQuery</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/store/">RelayModernStore</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/commit-mutation/">commitMutation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/request-subscription/">requestSubscription</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/graphql-and-directives/">GraphQL Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api-reference/legacy-apis/">Legacy APIs</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/graphql-server-specification/">GraphQL Server Specification</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/compiler/">Relay Compiler</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/type-emission/">Type Emission</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/guides/persisted-queries/">Persisted Queries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/network-layer/">Network Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/client-schema-extensions/">Client Schema Extensions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/testing-relay-components/">Testing Relay Components</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/testing-relay-with-preloaded-queries/">Testing Relay with Preloaded Queries</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Migration and Compatibility</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/migration-and-compatibility/">Upgrading to Relay Hooks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/migration-and-compatibility/suspense-compatibility/">Suspense Combatibility</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/migration-and-compatibility/relay-hooks-and-legacy-container-apis/">Relay Hooks and Legacy Container APIs</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Debugging</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/debugging/relay-devtools/">Relay DevTools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/debugging/inconsistent-typename-error/">Inconsistent Typename Error</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/debugging/declarative-mutation-directives/">Debugging Declarative Mutation Directives</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Principles and Architecture</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/principles-and-architecture/thinking-in-graphql/">Thinking in GraphQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/principles-and-architecture/thinking-in-relay/">Thinking in Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/principles-and-architecture/architecture-overview/">Architecture Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/principles-and-architecture/compiler-architecture/">Compiler Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/principles-and-architecture/runtime-architecture/">Runtime Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/principles-and-architecture/videos/">Videos</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/community-learning-resources/">Community Learning Resources</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/glossary/">Glossary</a></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><div><span class="badge badge--secondary">Version: v11.0.0</span></div><header><h1 class="docTitle_Oumm">Persisted Queries</h1></header><div class="markdown"><p>The relay compiler supports persisted queries. This is useful because:</p><ul><li><p>the client operation text becomes just an md5 hash which is usually shorter than the real
query string. This saves upload bytes from the client to the server.</p></li><li><p>the server can now whitelist queries which improves security by restricting the operations
that can be executed by a client.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="usage-on-the-client"></a>Usage on the client<a class="hash-link" href="#usage-on-the-client" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the---persist-output-flag"></a>The <code>--persist-output</code> flag<a class="hash-link" href="#the---persist-output-flag" title="Direct link to heading">#</a></h3><p>In your <code>npm</code> script in <code>package.json</code>, run the relay compiler using the <code>--persist-output</code> flag:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scripts&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;relay&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;relay-compiler --src ./src --schema ./schema.graphql --persist-output ./path/to/persisted-queries.json&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The <code>--persist-ouput</code> flag does 2 things:</p><ol><li><p>It converts all query and mutation operation texts to md5 hashes.</p><p>For example without <code>--persist-output</code>, a generated <code>ConcreteRequest</code> might look like below:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> node</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*: ConcreteRequest*/</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//... excluded for brevity</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kind&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Request&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;operationKind&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;query&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;TodoItemRefetchQuery&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword null nil" style="font-style:italic">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// NOTE: id is null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;query TodoItemRefetchQuery(\n  $itemID: ID!\n) {\n  node(id: $itemID) {\n    ...TodoItem_item_2FOrhs\n  }\n}\n\nfragment TodoItem_item_2FOrhs on Todo {\n    text\n    isComplete\n}\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//... excluded for brevity</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>With <code>--persist-output &lt;path&gt;</code> this becomes:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> node</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*: ConcreteRequest*/</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//... excluded for brevity</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kind&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Request&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;operationKind&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;query&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;TodoItemRefetchQuery&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3be4abb81fa595e25eb725b2c6a87508&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// NOTE: id is now an md5 hash of the query text</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword null nil" style="font-style:italic">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// NOTE: text is null now</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//... excluded for brevity</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>It generates a JSON file at the <code>&lt;path&gt;</code> you specify containing a mapping from query ids
to the corresponding operation texts.</p></li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scripts&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;relay&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;relay-compiler --src ./src --schema ./schema.graphql --persist-output ./src/queryMaps/queryMap.json&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The example above writes the complete query map file to <code>./src/queryMaps/queryMap.json</code>. You need to ensure all the directories
leading to the <code>queryMap.json</code> file exist.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="network-layer-changes"></a>Network layer changes<a class="hash-link" href="#network-layer-changes" title="Direct link to heading">#</a></h3><p>You&#x27;ll need to modify your network layer fetch implementation to pass a doc_id parameter in the POST body instead of a query parameter:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetchQuery</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">operation</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> variables</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;/graphql&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;POST&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    headers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;content-type&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;application/json&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    body</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">JSON</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">stringify</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      doc_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> operation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// NOTE: pass md5 hash to the server</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// query: operation.text, // this is now obsolete because text is null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">response</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="executing-persisted-queries-on-the-server"></a>Executing Persisted Queries on the Server<a class="hash-link" href="#executing-persisted-queries-on-the-server" title="Direct link to heading">#</a></h2><p>To execute client requests that send persisted queries instead of query text, your server will need to be able
to lookup the query text corresponding to each id. Typically this will involve saving the output of the <code>--persist-output &lt;path&gt;</code> JSON file to a database or some other storage mechanism, and retrieving the corresponding text for the ID specified by a client.</p><p>For universal applications where the client and server code are in one project, this is not an issue since you can place
the query map file in a common location accessible to both the client and the server.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="compile-time-push"></a>Compile time push<a class="hash-link" href="#compile-time-push" title="Direct link to heading">#</a></h3><p>For applications where the client and server projects are separate, one option is to have an additional npm run script
to push the query map at compile time to a location accessible by your server:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scripts&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;push-queries&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;node ./pushQueries.js&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;relay&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;relay-compiler --src ./src --schema ./schema.graphql --persist-ouput &lt;path&gt; &amp;&amp; npm run push-queries&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Some possibilities of what you can do in <code>./pushQueries.js</code>:</p><ul><li><p><code>git push</code> to your server repo</p></li><li><p>save the query maps to a database</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="run-time-push"></a>Run time push<a class="hash-link" href="#run-time-push" title="Direct link to heading">#</a></h3><p>A second more complex option is to push your query maps to the server at runtime, without the server knowing the query ids at the start.
The client optimistically sends a query id to the server, which does not have the query map. The server then in turn requests
for the full query text from the client so it can cache the query map for subsequent requests. This is a more complex approach
requiring the client and server to interact to exchange the query maps.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="simple-server-example"></a>Simple server example<a class="hash-link" href="#simple-server-example" title="Direct link to heading">#</a></h3><p>Once your server has access to the query map, you can perform the mapping. The solution varies depending on the server and
database technologies you use, so we&#x27;ll just cover the most common and basic example here.</p><p>If you use <code>express-graphql</code> and have access to the query map file, you can import the <code>--persist-output</code> JSON file directly and
perform the matching using the <code>matchQueryMiddleware</code> from <a href="https://github.com/yusinto/relay-compiler-plus" target="_blank" rel="noopener noreferrer">relay-compiler-plus</a>.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">Express</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;express&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> expressGraphql </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;express-graphql&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">matchQueryMiddleware</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;relay-compiler-plus&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> queryMapJson </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;./path/to/persisted-queries.json&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> app </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Express</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">use</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;/graphql&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">matchQueryMiddleware</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">queryMapJson</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">expressGraphql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">schema</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using---persist-output-and---watch"></a>Using <code>--persist-output</code> and <code>--watch</code><a class="hash-link" href="#using---persist-output-and---watch" title="Direct link to heading">#</a></h2><p>It is possible to continuously generate the query map files by using the <code>--persist-output</code> and <code>--watch</code> options simultaneously.
This only makes sense for universal applications i.e. if your client and server code are in a single project
and you run them both together on localhost during development. Furthermore, in order for the server to pick up changes
to the <code>queryMap.json</code>, you&#x27;ll need to have server side hot-reloading set up. The details on how to set this up
is out of the scope of this document.</p><div class="docsRating" id="docsRating"><hr>Is this page useful?<svg class="i_thumbsup" alt="Like" id="docsRating-like" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 81.13 89.76"><path d="M22.9 6a18.57 18.57 0 002.67 8.4 25.72 25.72 0 008.65 7.66c3.86 2 8.67 7.13 13.51 11 3.86 3.11 8.57 7.11 11.54 8.45s13.59.26 14.64 1.17c1.88 1.63 1.55 9-.11 15.25-1.61 5.86-5.96 10.55-6.48 16.86-.4 4.83-2.7 4.88-10.93 4.88h-1.35c-3.82 0-8.24 2.93-12.92 3.62a68 68 0 01-9.73.5c-3.57 0-7.86-.08-13.25-.08-3.56 0-4.71-1.83-4.71-4.48h8.42a3.51 3.51 0 000-7H12.28a2.89 2.89 0 01-2.88-2.88 1.91 1.91 0 01.77-1.78h16.46a3.51 3.51 0 000-7H12.29c-3.21 0-4.84-1.83-4.84-4a6.41 6.41 0 011.17-3.78h19.06a3.5 3.5 0 100-7H9.75A3.51 3.51 0 016 42.27a3.45 3.45 0 013.75-3.48h13.11c5.61 0 7.71-3 5.71-5.52-4.43-4.74-10.84-12.62-11-18.71-.15-6.51 2.6-7.83 5.36-8.56m0-6a6.18 6.18 0 00-1.53.2c-6.69 1.77-10 6.65-9.82 14.5.08 5.09 2.99 11.18 8.52 18.09H9.74a9.52 9.52 0 00-6.23 16.9 12.52 12.52 0 00-2.07 6.84 9.64 9.64 0 003.65 7.7 7.85 7.85 0 00-1.7 5.13 8.9 8.9 0 005.3 8.13 6 6 0 00-.26 1.76c0 6.37 4.2 10.48 10.71 10.48h13.25a73.75 73.75 0 0010.6-.56 35.89 35.89 0 007.58-2.18 17.83 17.83 0 014.48-1.34h1.35c4.69 0 7.79 0 10.5-1 3.85-1.44 6-4.59 6.41-9.38.2-2.46 1.42-4.85 2.84-7.62a41.3 41.3 0 003.42-8.13 48 48 0 001.59-10.79c.1-5.13-1-8.48-3.35-10.55-2.16-1.87-4.64-1.87-9.6-1.88a46.86 46.86 0 01-6.64-.29c-1.92-.94-5.72-4-8.51-6.3l-1.58-1.28c-1.6-1.3-3.27-2.79-4.87-4.23-3.33-3-6.47-5.79-9.61-7.45a20.2 20.2 0 01-6.43-5.53 12.44 12.44 0 01-1.72-5.36 6 6 0 00-6-5.86z"></path></svg><svg class="i_thumbsdown" alt="Dislike" id="docsRating-dislike" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 81.13 89.76"><path d="M22.9 6a18.57 18.57 0 002.67 8.4 25.72 25.72 0 008.65 7.66c3.86 2 8.67 7.13 13.51 11 3.86 3.11 8.57 7.11 11.54 8.45s13.59.26 14.64 1.17c1.88 1.63 1.55 9-.11 15.25-1.61 5.86-5.96 10.55-6.48 16.86-.4 4.83-2.7 4.88-10.93 4.88h-1.35c-3.82 0-8.24 2.93-12.92 3.62a68 68 0 01-9.73.5c-3.57 0-7.86-.08-13.25-.08-3.56 0-4.71-1.83-4.71-4.48h8.42a3.51 3.51 0 000-7H12.28a2.89 2.89 0 01-2.88-2.88 1.91 1.91 0 01.77-1.78h16.46a3.51 3.51 0 000-7H12.29c-3.21 0-4.84-1.83-4.84-4a6.41 6.41 0 011.17-3.78h19.06a3.5 3.5 0 100-7H9.75A3.51 3.51 0 016 42.27a3.45 3.45 0 013.75-3.48h13.11c5.61 0 7.71-3 5.71-5.52-4.43-4.74-10.84-12.62-11-18.71-.15-6.51 2.6-7.83 5.36-8.56m0-6a6.18 6.18 0 00-1.53.2c-6.69 1.77-10 6.65-9.82 14.5.08 5.09 2.99 11.18 8.52 18.09H9.74a9.52 9.52 0 00-6.23 16.9 12.52 12.52 0 00-2.07 6.84 9.64 9.64 0 003.65 7.7 7.85 7.85 0 00-1.7 5.13 8.9 8.9 0 005.3 8.13 6 6 0 00-.26 1.76c0 6.37 4.2 10.48 10.71 10.48h13.25a73.75 73.75 0 0010.6-.56 35.89 35.89 0 007.58-2.18 17.83 17.83 0 014.48-1.34h1.35c4.69 0 7.79 0 10.5-1 3.85-1.44 6-4.59 6.41-9.38.2-2.46 1.42-4.85 2.84-7.62a41.3 41.3 0 003.42-8.13 48 48 0 001.59-10.79c.1-5.13-1-8.48-3.35-10.55-2.16-1.87-4.64-1.87-9.6-1.88a46.86 46.86 0 01-6.64-.29c-1.92-.94-5.72-4-8.51-6.3l-1.58-1.28c-1.6-1.3-3.27-2.79-4.87-4.23-3.33-3-6.47-5.79-9.61-7.45a20.2 20.2 0 01-6.43-5.53 12.44 12.44 0 01-1.72-5.36 6 6 0 00-6-5.86z"></path></svg></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/relay/edit/master/website/versioned_docs/version-v11.0.0/guides/persisted-queries.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-04-07T21:59:07.000Z" class="docLastUpdatedAt_1Qna">4/7/2021</time> by <strong>Tim Yung</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/guides/type-emission/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Type Emission</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/guides/network-layer/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Network Layer Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#usage-on-the-client" class="table-of-contents__link">Usage on the client</a><ul><li><a href="#the---persist-output-flag" class="table-of-contents__link">The <code>--persist-output</code> flag</a></li><li><a href="#network-layer-changes" class="table-of-contents__link">Network layer changes</a></li></ul></li><li><a href="#executing-persisted-queries-on-the-server" class="table-of-contents__link">Executing Persisted Queries on the Server</a><ul><li><a href="#compile-time-push" class="table-of-contents__link">Compile time push</a></li><li><a href="#run-time-push" class="table-of-contents__link">Run time push</a></li><li><a href="#simple-server-example" class="table-of-contents__link">Simple server example</a></li></ul></li><li><a href="#using---persist-output-and---watch" class="table-of-contents__link">Using <code>--persist-output</code> and <code>--watch</code></a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" rel="noopener noreferrer" href="/docs">Introduction</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" rel="noopener noreferrer" href="/users">User Showcase</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img class="footer__logo" src="/img/relay.svg"></div></div></div></footer></div>
<script src="/styles.b3d6ad44.js"></script>
<script src="/runtime~main.97b369c3.js"></script>
<script src="/main.1ad2bb6a.js"></script>
<script src="/1.5180c3fa.js"></script>
<script src="/2.77ef3bb8.js"></script>
<script src="/3.e784de96.js"></script>
<script src="/1be78505.92f65075.js"></script>
<script src="/247.ab089541.js"></script>
<script src="/b81f3fb0.b00a0714.js"></script>
<script src="/17896441.02b9ab90.js"></script>
<script src="/6783d5f5.b2df26ef.js"></script>
</body>
</html>